-- =========================================================
-- CHARGEMENTS DU SCRIPT
local function LoadModule(url)
    local module
    repeat
        local success, result = pcall(function()
            return loadstring(game:HttpGet(url))()
        end)
        if success then
            module = result
        else
            warn("Module non chargé, retry dans 1s : "..url)
            wait(1)
        end
    until module
    return module
end

local player = game.Players.LocalPlayer
repeat wait() until player and player.Character and player.Character:FindFirstChild("HumanoidRootPart")
-- =========================================================
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/ImBrokz89/test/main/addons"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/ImBrokz89/test/main/Maddons"))()

local Window = Fluent:CreateWindow({
   Title = "Omega Hub I Fabled Legacy RPG",
   TabWidth = 160,
   Size = UDim2.fromOffset(580, 460),
   Theme = "Dark",
   Acrylic = false,
   MinimizeKey = Enum.KeyCode.End 
})

Fluent:Notify({
   Title = "Notification",
   Content = "Script injected :)",
   Duration = 2
})

local Tabs = {
    Main = Window:AddTab({ Title = "Auto Farm", Icon = "swords" }),
   -- Raid = Window:AddTab({ Title = "Raid", Icon = "sword" }),
   -- Players = Window:AddTab({Title = "Player", Icon = "layers" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "flame" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
 }
-- =========================================================
-- AUTO FARM DUNGEON HEROES (TOUS LES MOBS)

repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

local LocalPlayer = Players.LocalPlayer

local AutoFarm = true
local HeightAboveMob = 7
local AttackDelay = 0.1

local Character, Humanoid, HRP
local NoclipConnection, HeartbeatConnection

local function GetModelRoot(model)
    if model.PrimaryPart then return model.PrimaryPart end
    for _, v in pairs(model:GetDescendants()) do
        if v:IsA("BasePart") and v.Name:lower():find("root") then
            return v
        end
    end
    for _, v in pairs(model:GetDescendants()) do
        if v:IsA("BasePart") then return v end
    end
    return nil
end

local function SetupCharacter(char)
    Character = char
    Humanoid = char:WaitForChild("Humanoid")
    HRP = char:WaitForChild("HumanoidRootPart")

    if NoclipConnection then NoclipConnection:Disconnect() end
    if HeartbeatConnection then HeartbeatConnection:Disconnect() end

    Humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
    Humanoid:SetStateEnabled(Enum.HumanoidStateType.GettingUp, false)
    Humanoid.PlatformStand = true

    NoclipConnection = RunService.Stepped:Connect(function()
        if Character then
            for _, v in pairs(Character:GetDescendants()) do
                if v:IsA("BasePart") then
                    v.CanCollide = false
                    v.Velocity = Vector3.zero
                end
            end
        end
    end)

    HeartbeatConnection = RunService.Heartbeat:Connect(function()
        if not AutoFarm then return end
        if not HRP then return end

        local enemiesFolder = workspace:FindFirstChild("Enemies")
        if not enemiesFolder then return end

        local closest, shortestDist = nil, math.huge
        for _, mobModel in pairs(enemiesFolder:GetChildren()) do
            if mobModel:IsA("Model") then
                local hum = mobModel:FindFirstChildOfClass("Humanoid")
                local root = GetModelRoot(mobModel)
                if hum and hum.Health > 0 and root then
                    local d = (root.Position - HRP.Position).Magnitude
                    if d < shortestDist then
                        shortestDist = d
                        closest = mobModel
                    end
                end
            end
        end

        if closest then
            local root = GetModelRoot(closest)
            if root then
                HRP.CFrame = root.CFrame * CFrame.new(0, HeightAboveMob, 0)
            end
        end
    end)
end

task.spawn(function()
    while task.wait(AttackDelay) do
        if not AutoFarm then continue end

        ReplicatedStorage:WaitForChild("Swing"):FireServer()

        local cdQ = LocalPlayer:FindFirstChild("cooldownQ")
        if cdQ and cdQ.Value <= 0 then
            ReplicatedStorage:WaitForChild("useSpell"):FireServer("Q")
        end

        local cdE = LocalPlayer:FindFirstChild("cooldownE")
        if cdE and cdE.Value <= 0 then
            ReplicatedStorage:WaitForChild("useSpell"):FireServer("E")
        end
    end
end)

if LocalPlayer.Character then
    SetupCharacter(LocalPlayer.Character)
end

LocalPlayer.CharacterAdded:Connect(function(char)
    task.wait(0.5)
    SetupCharacter(char)
end)

Tabs.Main:AddToggle("AutoFarm", {
    Title = "Auto Farm",
    Description = "TP mobs + attaque + Q / E",
    Default = false,
    Callback = function(Value)
        AutoFarm = Value
    end
})

-- =========================================================
-- AUTO start
local autoStart = false
Tabs.Main:AddToggle("AutoStartDungeon", {
    Title = "Auto Start Dungeon", 
    Description = "Active l'auto start du dungeon",
    Default = false,
    Callback = function(state)
        autoStart = state
        if state then
            print("Auto Start Activé")
            spawn(function()
                while autoStart do
                    local args = {true}
                    game:GetService("ReplicatedStorage"):WaitForChild("StartDungeon"):FireServer(unpack(args))
                    wait(1)
                end
            end)
        else
            print("Auto Start Désactivé")
        end
    end 
})
-- =========================================================
-- AUTO RETRY
local autoRetry = false

Tabs.Main:AddToggle("AutoRetry", {
    Title = "Auto Retry",
    Description = "Relance automatiquement le vote",
    Default = false,
    Callback = function(state)
        autoRetry = state
        if state then
            print("Auto Retry Activé")
            spawn(function()
                while autoRetry do
                    local args = {"repeat"}
                    game:GetService("ReplicatedStorage"):WaitForChild("voteRemote"):FireServer(unpack(args))
                    wait(1)
                end
            end)
        else
            print("Auto Retry Désactivé")
        end
    end
})



-- =========================================================
-- AUTO RE-INJECTIONS AUTOMATIQUE
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local AutoReInjectEnabled = false
local TeleportCheck = false

local queueteleport = queue_on_teleport or 
                      (syn and syn.queue_on_teleport) or 
                      (fluxus and fluxus.queue_on_teleport) or
                      queueonteleport

local ScriptURL = "https://raw.githubusercontent.com/Omegahub1/20-20-/refs/heads/main/FabledLegacy"

if queueteleport then
    LocalPlayer.OnTeleport:Connect(function(State)
        if AutoReInjectEnabled and not TeleportCheck then
            TeleportCheck = true
            local code = "repeat task.wait() until game:IsLoaded() wait(2) loadstring(game:HttpGet('" .. ScriptURL .. "'))()"
            queueteleport(code)
        end
    end)
end

Tabs.Misc:AddToggle("AutoReInject", {
    Title = "Auto Re-inject",
    Description = "Automatically re-inject script after teleporting",
    Default = false,
    Callback = function(Value)
        if not queueteleport then
            return
        end
        
        AutoReInjectEnabled = Value
        TeleportCheck = false
    end
})

-- =========================================================
-- CONFIG SYSTEM

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
SaveManager:LoadAutoloadConfig()
Window:SelectTab(1)


-- =========================
-- MOBILE / PC BUTTON

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FluentMobileButton"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

local openButton = Instance.new("ImageButton")
openButton.Size = UDim2.new(0, 40, 0, 40)
openButton.Position = UDim2.new(0, 10, 0, 10)
openButton.BackgroundColor3 = Color3.fromRGB(0,0,0)
openButton.BackgroundTransparency = 0.5
openButton.Image = "rbxassetid://133520358863074"
openButton.ScaleType = Enum.ScaleType.Fit
openButton.BorderSizePixel = 0
openButton.Parent = screenGui
openButton.ZIndex = 10

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 20)
uicorner.Parent = openButton

local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    openButton.Position = UDim2.new(
        startPos.X.Scale, startPos.X.Offset + delta.X,
        startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
end

openButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = openButton.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

openButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

openButton.MouseButton1Click:Connect(function()
    local VirtualInputManager = game:GetService("VirtualInputManager")
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
end)

local function removeButton()
    if openButton and openButton.Parent then
        openButton:Destroy()
    end
end

if Window.UI and Window.UI.CloseButton then
    Window.UI.CloseButton.MouseButton1Click:Connect(function()
        removeButton()
    end)
else
    if Window.OnClose then
        local oldClose = Window.OnClose
        Window.OnClose = function()
            removeButton()
            if oldClose then oldClose() end
        end
    end
end
