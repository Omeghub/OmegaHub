-- =========================================================
-- CHARGEMENT DE FLUENT ET INTERFACE
-- =========================================================
local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()
local SaveManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/ImBrokz89/test/main/addons"))()
local InterfaceManager = loadstring(game:HttpGet("https://raw.githubusercontent.com/ImBrokz89/test/main/Maddons"))()

local Window = Fluent:CreateWindow({
   Title = "Escape Tsunami For Brainrots I Omega Hub",
   TabWidth = 160,
   Size = UDim2.fromOffset(580, 460),
   Theme = "Dark",
   Acrylic = false,
   MinimizeKey = Enum.KeyCode.End 
})

local Tabs = {
    --Main = Window:AddTab({ Title = "Auto Farm", Icon = "swords" }),
    Farm = Window:AddTab({ Title = "Farm", Icon = "sword" }),
    Players = Window:AddTab({Title = "Player", Icon = "layers" }),
    --Misc = Window:AddTab({ Title = "Misc", Icon = "flame" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}
-- =========================================================
-- REMOVE ACTIVE TSUNAMIS (FLUENT TOGGLE)
local Workspace = game:GetService("Workspace")
local ActiveTsunamis = Workspace:WaitForChild("ActiveTsunamis")

local RemoveTsunamis = false
local TsunamiConnection = nil

local function clearTsunamis()
    for _, obj in ipairs(ActiveTsunamis:GetChildren()) do
        if obj:IsA("Model") then
            obj:Destroy()
        end
    end
end

local Section = Tabs.Farm:AddSection("Remove Waters")

Tabs.Farm:AddToggle("RemoveTsunamis", {
    Title = "Remove Tsunamis",
    Default = false,
    Callback = function(state)
        RemoveTsunamis = state
        if state then
            clearTsunamis()
            TsunamiConnection = ActiveTsunamis.ChildAdded:Connect(function(child)
                if RemoveTsunamis and child:IsA("Model") then
                    task.wait()
                    child:Destroy()
                end
            end)
        else
            if TsunamiConnection then
                TsunamiConnection:Disconnect()
                TsunamiConnection = nil
            end
        end
    end
})
-- =========================================================
-- AUTO GRAB + AUTO PLACE (BASE 1 → 5)
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")

local LocalPlayer = Players.LocalPlayer
local PlayerName = LocalPlayer.Name
local UserId = LocalPlayer.UserId

local BrainrotsFolder = Workspace:WaitForChild("ActiveBrainrots")
local BasesFolder = Workspace:WaitForChild("Bases")

local AutoGrab = false
local AutoPlace = false
local Connections = {}

local BrainrotNames = {
    "Fragola La La La",
    "La Vacca Black Hole Goat",
    "Job Job Job Sahur",
    "Dug Dug Dug",
    "Bisonte Giuppitere",
    "Alessio",
    "Esok Sekolah",
    "Caffe Trinity"
}

local function getHRP()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

local function getMyBase()
    for i = 1, 5 do
        local base = BasesFolder:FindFirstChild("Base"..i)
        if base then
            local holder = base:GetAttribute("Holder")
            if holder == UserId then
                return base
            end
        end
    end
    warn("[WARN] Aucune base trouvée pour "..PlayerName)
end

local function tpToBase()
    local base = getMyBase()
    if not base then
        warn("[WARN] Impossible de TP : base non trouvée")
        return
    end

    local parts = {}
    for _, v in ipairs(base:GetDescendants()) do
        if v:IsA("BasePart") then
            table.insert(parts, v)
        end
    end

    local cframe
    if #parts > 0 then
        local sum = Vector3.new(0,0,0)
        for _, p in ipairs(parts) do
            sum = sum + p.Position
        end
        cframe = CFrame.new(sum / #parts)
    else
        cframe = base:GetPivot()
    end

    getHRP().CFrame = cframe + Vector3.new(0,3,0)
    print("[INFO] TP sur le modèle de la base :", base.Name)
end

local function getModelCFrame(model)
    local parts = {}
    for _, v in ipairs(model:GetDescendants()) do
        if v:IsA("BasePart") then
            table.insert(parts, v)
        end
    end

    if #parts > 0 then
        local sum = Vector3.new(0,0,0)
        for _, p in ipairs(parts) do
            sum = sum + p.Position
        end
        return CFrame.new(sum / #parts)
    else
        return model:GetPivot()
    end
end

local function getPrompt(model)
    for _, v in ipairs(model:GetDescendants()) do
        if v:IsA("ProximityPrompt") then
            return v
        end
    end
end

local function handleBrainrot(model)
    if not AutoGrab or not table.find(BrainrotNames, model.Name) then return end

    local cframe
    repeat
        cframe = getModelCFrame(model)
        task.wait(0.1)
    until cframe or not AutoGrab

    if not cframe then
        warn("[WARN] Impossible de TP sur Brainrot :", model.Name)
        return
    end

    getHRP().CFrame = cframe + Vector3.new(0,3,0)
    task.wait(1)

    -- Fire ProximityPrompt si présent
    local prompt = getPrompt(model)
    if prompt then
        fireproximityprompt(prompt)
    else
        warn("[WARN] Pas de ProximityPrompt sur Brainrot :", model.Name)
    end

    tpToBase()
end

local function autoPlaceBrainrot()
    if not AutoPlace then return end

    local base = getMyBase()
    if not base then return end

    local slots = base:FindFirstChild("Slots")
    if not slots then
        warn("[WARN] Slots non trouvés dans la base :", base.Name)
        return
    end

    for i = 1, 30 do
        local slot = slots:FindFirstChild("Slot"..i)
        if slot then
            local hasTool = false
            for _, child in ipairs(slot:GetChildren()) do
                if child:IsA("Tool") then
                    hasTool = true
                    break
                end
            end
            if hasTool then
                continue
            end

            local cframe = getModelCFrame(slot)
            local prompt = getPrompt(slot)
            if cframe and prompt then
                getHRP().CFrame = cframe + Vector3.new(0,3,0)
                task.wait(0.3)

                fireproximityprompt(prompt)
                task.wait(0.5)
                break
            end
        end
    end
end

local function scanAll()
    for _, folder in ipairs(BrainrotsFolder:GetChildren()) do
        for _, model in ipairs(folder:GetChildren()) do
            if table.find(BrainrotNames, model.Name) then
                task.spawn(handleBrainrot, model)
            end
        end
    end
end

local function connectAll()
    for _, folder in ipairs(BrainrotsFolder:GetChildren()) do
        table.insert(Connections,
            folder.ChildAdded:Connect(function(child)
                if table.find(BrainrotNames, child.Name) then
                    task.wait()
                    handleBrainrot(child)
                end
            end)
        )
    end
end

local function disconnectAll()
    for _, c in ipairs(Connections) do
        c:Disconnect()
    end
    table.clear(Connections)
end

local Section = Tabs.Farm:AddSection("Grabe And Place Brainrot")

Tabs.Farm:AddParagraph({
    Title = "Auto Grab",
    Content = "Auto Grab Fragola La La La and\nLa Vacca Black Hole Goat and \n New BrainRot"
})

Tabs.Farm:AddToggle("AutoGrabBrainrot", {
    Title = "Auto Grab Brainrot",
    Default = false,
    Callback = function(v)
        AutoGrab = v
        if v then
            scanAll()
            connectAll()
        else
            disconnectAll()
        end
    end
})

Tabs.Farm:AddToggle("AutoPlaceBrainrot", {
    Title = "Auto Place Brainrot",
    Default = false,
    Callback = function(v)
        AutoPlace = v
        if v then
            task.spawn(function()
                while AutoPlace do
                    autoPlaceBrainrot()
                    task.wait(1)
                end
            end)
        else
        end
    end
})

-- =========================================================
-- AUTO COLLECT
local Section = Tabs.Farm:AddSection("Collect")


local AutoCollect = false

local function autoCollect()
    if not AutoCollect then return end

    local base = getMyBase()
    if not base then return end

    local slots = base:FindFirstChild("Slots")
    if not slots then return end

    for i = 1, 30 do
        local slot = slots:FindFirstChild("Slot"..i)
        if slot then
            local collectPart = slot:FindFirstChild("Collect")
            if collectPart then
                local gui = collectPart:FindFirstChildOfClass("SurfaceGui")
                if gui and gui.Enabled then
                    -- TP sur la part Collect
                    getHRP().CFrame = collectPart.CFrame + Vector3.new(0,3,0)
                    print("[INFO] TP sur Collect de Slot"..i)
                    task.wait(0.3)
                end
            end
        end
    end
end

Tabs.Farm:AddToggle("AutoCollect", {
    Title = "Auto Collect",
    Default = false,
    Callback = function(v)
        AutoCollect = v
        if v then
            print("[INFO] AutoCollect activé")
            task.spawn(function()
                while AutoCollect do
                    autoCollect()
                    task.wait(1)
                end
            end)
        else
            print("[INFO] AutoCollect désactivé")
        end
    end
})


-- =========================================================
-- CONFIGURATION SYSTEM
-- =========================================================
SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
SaveManager:LoadAutoloadConfig()
Window:SelectTab(1)

-- =========================
-- MOBILE / PC BUTTON

local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FluentMobileButton"
screenGui.Parent = playerGui
screenGui.ResetOnSpawn = false

local openButton = Instance.new("ImageButton")
openButton.Size = UDim2.new(0, 40, 0, 40)
openButton.Position = UDim2.new(0, 10, 0, 10)
openButton.BackgroundColor3 = Color3.fromRGB(0,0,0)
openButton.BackgroundTransparency = 0.5
openButton.Image = "rbxassetid://133520358863074"
openButton.ScaleType = Enum.ScaleType.Fit
openButton.BorderSizePixel = 0
openButton.Parent = screenGui
openButton.ZIndex = 10

local uicorner = Instance.new("UICorner")
uicorner.CornerRadius = UDim.new(0, 20)
uicorner.Parent = openButton

local dragging
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    openButton.Position = UDim2.new(
        startPos.X.Scale, startPos.X.Offset + delta.X,
        startPos.Y.Scale, startPos.Y.Offset + delta.Y
    )
end

openButton.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = openButton.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

openButton.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

openButton.MouseButton1Click:Connect(function()
    local VirtualInputManager = game:GetService("VirtualInputManager")
    VirtualInputManager:SendKeyEvent(true, Enum.KeyCode.LeftControl, false, game)
    VirtualInputManager:SendKeyEvent(false, Enum.KeyCode.LeftControl, false, game)
end)

local function removeButton()
    if openButton and openButton.Parent then
        openButton:Destroy()
    end
end

if Window.UI and Window.UI.CloseButton then
    Window.UI.CloseButton.MouseButton1Click:Connect(function()
        removeButton()
    end)
else
    if Window.OnClose then
        local oldClose = Window.OnClose
        Window.OnClose = function()
            removeButton()
            if oldClose then oldClose() end
        end
    end
end
